import java.io.*;
import java.net.InetAddress;
import java.net.Socket;
import java.nio.charset.StandardCharsets;

public class ServerTask implements Runnable {
    private final Socket socket;//本线程创建一个socket

    public ServerTask(Socket socket) {
        this.socket = socket;
    }//将本线程的socket设为Client连接过来的socket

    @Override
    public void run() {
        try {
            //获取输入字节流(即客户端发送来的字节流)
            InputStream is = socket.getInputStream();
            //字节流转换为字符流
            InputStreamReader isReader = new InputStreamReader(is, StandardCharsets.UTF_8);
            //字符流转换为缓冲字符流
            BufferedReader reader = new BufferedReader(isReader);

            //获取输出字符流(即回复给客户端的消息)
            OutputStream os = socket.getOutputStream();
            PrintStream out = new PrintStream(os, true, "UTF-8");

            InetAddress clientIP = socket.getInetAddress();//获取客户端IP
            int clientPort = socket.getPort();//获取客户端端口

            out.println("连接成功");
            String msg = reader.readLine();//接收请求
            System.out.println("与客户端" + clientIP + ":" + clientPort + "连接并收到一个请求：" + msg);//打印请求

            //获取所需服务号
            String[] strings=msg.split("~");//分割字符串，提取服务号的字符串形式
            int request = Integer.parseInt(strings[0]);//字符串转整数

            //返回信息
            String response = "null";

            //根据服务号来进行相应服务
            switch (request){
                //注册
                case 0: {
                    String[] registerText = strings[1].split("##");//分割注册信息
                    //判断该账号是否已被注册
                    if (registerScreen("C:\\Users\\ying1\\Desktop\\Server\\用户信息.txt", registerText[1])) {
                        writeFile(strings[1], "用户信息.txt");
                        response = "true";//注册成功
                    } else response = "false";//注册失败

                    break;
                }
                //登录
                case 1:{
                    String[] signInText=strings[1].split("##");//分割登录信息
                    //判断账号密码是否存在且正确
                    if (signInScreen("C:\\Users\\ying1\\Desktop\\Server\\用户信息.txt",signInText[0],signInText[1])){
                        response="true";
                    }
                    else response="false";

                    break;
                }
                //服务失败
                default: {
                    System.out.println("服务失败");
                    break;
                }
            }

            out.println(response);//把数据传送去客户端
            out.println("over");//通知客户端服务成功
            System.out.println("服务成功");
            socket.close();//断开连接

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    //登录信息筛选
    private static boolean signInScreen(String name, String account, String password) throws IOException {
        BufferedReader reader = new BufferedReader(new FileReader(name));//创建缓冲读取流
        String line;
        while ((line=reader.readLine())!=null){
            String[] splits = line.split("##");
            //账号密码比对,若有该账号和密码则返回true
            if (splits[1].equals(account)&&splits[2].equals(password)){
                return true;
            }
        }
        return false;
    }

    //注册信息筛选
    private static boolean registerScreen(String name, String account) throws IOException {
        BufferedReader reader = new BufferedReader(new FileReader(name));//创建缓冲读取流
        String line;
        while ((line=reader.readLine())!=null){
            String[] splits = line.split("##");
            //账号比对,若有该账号则返回false
            if (splits[1].equals(account)){
                return false;
            }
        }
        return true;
    }

    //写信息入File
    private static boolean writeFile(String line, String name) throws IOException {
        File file=new File("C:\\Users\\ying1\\Desktop\\Server\\"+name);
        FileOutputStream fos=new FileOutputStream(file,true);//创建一个不会覆盖文本的写入流
        byte[] buff;
        buff=line.getBytes();//读取写入信息到一个buff缓冲区
        fos.write(buff);//写入信息
        fos.write("\n".getBytes());//写入换行
        fos.flush();//刷新
        fos.close();//关闭写入流
        return true;
    }
}